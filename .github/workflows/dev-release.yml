name: DEV Release Automation

on:
  push:
    branches:
      - alpha
  workflow_dispatch:

jobs:
  manage-release:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository with Submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_TOKEN }}

      - name: ðŸ” Show all submodules (initial state)
        run: |
          echo "Listing submodules from .gitmodules:"
          cat .gitmodules || echo "No .gitmodules found"

      - name: ðŸ”„ Init & update all submodules recursively
        run: |
          echo "Initializing all submodules recursively..."
          git submodule update --init --recursive

          echo "âœ… Submodules after init:"
          git submodule status --recursive

      - name: ðŸ”€ Switch all submodules to 'dev' branch (if exists)
        run: |
          echo "ðŸ“¦ Updating submodules to 'dev' branches..."

          git submodule foreach --recursive '
            echo ""
            echo "ðŸ“ Submodule: $name"
            echo "ðŸ“ Path: $path"
            git fetch origin
            if git show-ref --verify --quiet refs/remotes/origin/dev; then
              echo "âœ… Branch 'dev' found. Checking out..."
              git checkout dev
              git pull origin dev
            else
              echo "âš ï¸ Branch 'dev' not found in $name"
            fi
          '


      - name: ðŸ’¾ Commit updated submodule references (if any)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [[ -n $(git status --porcelain) ]]; then
            git add .
            git commit -m "Update submodules to dev branches"
            echo "âœ… Changes committed."
          else
            echo "â„¹ï¸ No changes to commit."
          fi

      - name: ðŸ—‘ï¸ Delete existing DEV release (if exists)
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          if gh release view DEV &>/dev/null; then
            echo "ðŸ§¹ Deleting existing DEV release..."
            gh release delete DEV --yes
          else
            echo "â„¹ï¸ No existing DEV release found."
          fi

      - name: ðŸ“¦ Create ZIP with full source including submodules
        run: |
          timestamp=$(TZ=Europe/Vienna date +"%Y%m%d_%H%M%S")
          echo "ðŸ•’ Using timestamp: $timestamp"
          echo "$timestamp" > release_timestamp.txt

          mkdir package
          rsync -a --exclude='.git' ./ package/

          git submodule foreach --recursive 'bash -c "
            fullpath=\$(realpath .)
            relpath=\${fullpath#\$(realpath \"\$toplevel\")/}
            echo \"ðŸ“‚ Including submodule: \$relpath\"
            mkdir -p \"\$toplevel/package/\$relpath\"
            rsync -a --exclude=.git \"\$fullpath/\" \"\$toplevel/package/\$relpath/\"
          "'

          cd package
          zip -r ../ddpc_alpha.zip . -x "*.git*" "*.github*" "*.vscode*" "*node_modules*"
          cd ..
          echo "âœ… Created ddpc_alpha.zip"

      - name: ðŸš€ Create new DEV release and upload ZIP
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          timestamp=$(cat release_timestamp.txt)
          release_name="alpha_${timestamp}"
          echo "ðŸ“¤ Creating release: $release_name"
          gh release create DEV ddpc_alpha.zip \
            --title "$release_name" \
            --notes "Automatisch generiertes DEV Release vom $timestamp"
