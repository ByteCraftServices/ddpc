name: DEV Release Automation

on:
  push:
    branches:
      - alpha
  workflow_dispatch:

jobs:
  manage-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository with Submodules
        uses: actions/checkout@v3
        with:
          submodules: recursive
          token: ${{ secrets.PERSONAL_TOKEN }}

      - name: Switch submodules to 'dev' branch
        run: |
          git submodule foreach '
            echo "Switching $name to dev branch"
            git fetch origin dev
            git checkout dev || echo "Branch dev not found in $name"
            git pull origin dev || echo "Could not pull dev branch in $name"
          '

      - name: Delete existing DEV releases
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          releases=$(gh release list --limit 100 --json tagName,name --jq '.[] | select(.tagName == "DEV") | .name')
          if [ -n "$releases" ]; then
            echo "Deleting existing DEV release(s)..."
            gh release delete DEV --yes
          else
            echo "No DEV release found to delete."
          fi

      - name: Create new DEV release
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          timestamp=$(date +"%Y%m%d_%H%M%S")
          release_name="alpha_${timestamp}"
          echo "Creating release: $release_name"
          gh release create DEV --title "$release_name" --notes "Automatisch generiertes DEV Release vom $timestamp"
