name: DEV Release Automation

on:
  push:
    branches:
      - alpha
  workflow_dispatch:

jobs:
  manage-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository with Submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_TOKEN }}

      - name: Initialize and switch submodules to 'dev' branch (with logging)
        run: |
          echo "ðŸ”„ Initializing submodules..."
          git submodule update --init --recursive

          echo "ðŸ” Fetching and switching submodules to 'dev' branch..."

          failed=0

          git submodule foreach --recursive '
            echo ""
            echo "ðŸ“¦ Submodule: $name"
            git remote -v
            git fetch origin

            if git show-ref --verify --quiet refs/remotes/origin/dev; then
              echo "âœ… dev branch found in $name. Checking out..."
              git checkout dev
              git pull origin dev
              echo "âœ… Switched to dev branch in $name"
            else
              echo "âŒ dev branch not found for submodule $name"
              failed=1
            fi
          '

          if [ "$failed" -ne 0 ]; then
            echo "â— One or more submodules failed to switch to the dev branch."
            exit 1
          fi

      - name: Commit updated submodule references
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [[ -n $(git status --porcelain) ]]; then
            git add .
            git commit -m "Update submodules to dev branches"
          else
            echo "No changes to commit"
          fi

      - name: Delete existing DEV release
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          if gh release view DEV &>/dev/null; then
            echo "ðŸ—‘ï¸ Deleting existing DEV release..."
            gh release delete DEV --yes
          else
            echo "â„¹ï¸ No existing DEV release found."
          fi

      - name: Create ZIP with full source including submodules
        run: |
          timestamp=$(TZ=Europe/Vienna date +"%Y%m%d_%H%M%S")
          echo "Using timestamp: $timestamp"
          echo "$timestamp" > release_timestamp.txt

          mkdir package
          rsync -a --
