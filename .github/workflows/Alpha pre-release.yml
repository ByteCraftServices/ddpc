name: Alpha pre-release

on:
  workflow_dispatch: {}

permissions:
  contents: write  # required for creating releases and uploading assets

jobs:
  alpha_prerelease:
    name: Create alpha pre-release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout alpha branch with submodules
        uses: actions/checkout@v4
        with:
          ref: alpha
          submodules: recursive  # ✅ Submodules rekursiv laden
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_TOKEN }}  # ✅ PAT für private Submodules

      - name: Sync and update submodules
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive

      # Optional: Submodules auf bestimmten Branch switchen
      - name: Switch submodules to 'alpha' branch (optional)
        run: |
          git submodule foreach '
            echo "Checking $name for alpha branch"
            git fetch origin alpha || true
            if git show-ref --verify --quiet refs/remotes/origin/alpha; then
              git checkout alpha
              git pull origin alpha
            else
              echo "Branch alpha not found in $name, staying on current branch"
            fi
          '

      - name: Determine version
        id: version
        run: |
          TAG_COUNT=$(git tag --list | wc -l | tr -d ' ')
          VERSION="0.1.${TAG_COUNT}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Create alpha.zip
        run: |
          zip -r alpha.zip . -x '*.git*'  # ✅ .git-Ordner ausschließen

      - name: Create GitHub pre-release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Alpha v${{ steps.version.outputs.version }}
          prerelease: true
          target_commitish: alpha
          files: |
            alpha.zip
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
