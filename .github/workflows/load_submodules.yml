name: Branch Artifact Build

on:
  push:
    branches: [main, alpha, beta]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  branch_artifact:
    runs-on: ubuntu-latest

    steps:
    - name: Determine target branch
      id: target
      env:
        REF_NAME: ${{ github.ref_name }}
      run: |
        BRANCH="$REF_NAME"

        SAFE_BRANCH="${BRANCH//\//-}"

        echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
        echo "safe_branch=$SAFE_BRANCH" >> "$GITHUB_OUTPUT"

    - name: Checkout target branch with submodules
      uses: actions/checkout@v4
      with:
        ref: ${{ steps.target.outputs.branch }}
        submodules: recursive
        fetch-depth: 0
        token: ${{ secrets.PERSONAL_TOKEN }}

    - name: Sync and update submodules
      run: |
        git submodule sync --recursive
        git submodule update --init --recursive

    - name: Switch submodules to target branch (optional)
      run: |
        git submodule foreach '
          BRANCH="${{ steps.target.outputs.branch }}"
          echo "Checking $name for $BRANCH branch"
          git fetch origin "$BRANCH" || true
          if git show-ref --verify --quiet "refs/remotes/origin/$BRANCH"; then
            git checkout "$BRANCH"
            git pull origin "$BRANCH"
          else
            echo "Branch $BRANCH not found in $name, staying on current branch"
          fi
        '

    - name: Create branch zip archive
      run: |
        ZIP_NAME="${{ steps.target.outputs.safe_branch }}.zip"
        zip -r "$ZIP_NAME" . -x '*.git*'

    - name: Upload branch zip artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.target.outputs.safe_branch }}-zip
        path: ${{ steps.target.outputs.safe_branch }}.zip
        if-no-files-found: error
        retention-days: 14

    - name: Create GitHub Release and upload ZIP
      env:
        GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        ZIP_NAME: ${{ steps.target.outputs.safe_branch }}.zip
        REPOSITORY: ${{ github.repository }}
      run: |
        set -e
        gh release create $BRANCH "$ZIP_NAME" --repo "$REPOSITORY" --title "Automated ZIP for $BRANCH" --notes "Automated build artifact for $BRANCH branch."

    - name: Show static download link
      env:
        REPOSITORY: ${{ github.repository }}
        ZIP_NAME: ${{ steps.target.outputs.safe_branch }}.zip
      run: |
        echo "Static download URL: https://github.com/${REPOSITORY}/releases/download/channel/${ZIP_NAME}"

    - name: Delete artifacts branch
      env:
        REPOSITORY: ${{ github.repository }}
        GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
      run: |
        set -e
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git clone --depth 1 "https://x-access-token:${GH_TOKEN}@github.com/${REPOSITORY}.git" repo_tmp
        cd repo_tmp
        if git show-ref --verify --quiet refs/heads/artifacts; then
          git push origin --delete artifacts
          echo "artifacts branch deleted."
        else
          echo "artifacts branch does not exist."
        fi
        cd ..
        rm -rf repo_tmp
