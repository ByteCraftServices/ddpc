name: Branch Artifact Build

on:
  push:
    branches:
      - '**'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Optional: branch to build (default = selected/ref branch)'
        required: false
        default: ''

jobs:
  branch_artifact:
    runs-on: ubuntu-latest

    steps:
    - name: Determine target branch
      id: target
      env:
        EVENT_NAME: ${{ github.event_name }}
        REF_NAME: ${{ github.ref_name }}
        MANUAL_BRANCH: ${{ github.event.inputs.branch }}
      run: |
        BRANCH="$REF_NAME"
        if [ "$EVENT_NAME" = "workflow_dispatch" ] && [ -n "$MANUAL_BRANCH" ]; then
          BRANCH="$MANUAL_BRANCH"
        fi

        SAFE_BRANCH="${BRANCH//\//-}"

        echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
        echo "safe_branch=$SAFE_BRANCH" >> "$GITHUB_OUTPUT"

    - name: Checkout target branch with submodules
      uses: actions/checkout@v4
      with:
        ref: ${{ steps.target.outputs.branch }}
        submodules: recursive
        fetch-depth: 0
        token: ${{ secrets.PERSONAL_TOKEN }}

    - name: Sync and update submodules
      run: |
        git submodule sync --recursive
        git submodule update --init --recursive

    - name: Switch submodules to target branch (optional)
      run: |
        git submodule foreach '
          BRANCH="${{ steps.target.outputs.branch }}"
          echo "Checking $name for $BRANCH branch"
          git fetch origin "$BRANCH" || true
          if git show-ref --verify --quiet "refs/remotes/origin/$BRANCH"; then
            git checkout "$BRANCH"
            git pull origin "$BRANCH"
          else
            echo "Branch $BRANCH not found in $name, staying on current branch"
          fi
        '

    - name: Create branch zip archive
      run: |
        ZIP_NAME="${{ steps.target.outputs.safe_branch }}.zip"
        zip -r "$ZIP_NAME" . -x '*.git*'

    - name: Upload branch zip artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.target.outputs.safe_branch }}-zip
        path: ${{ steps.target.outputs.safe_branch }}.zip
        if-no-files-found: error
        retention-days: 14
