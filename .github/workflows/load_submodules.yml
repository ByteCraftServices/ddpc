name: Branch Artifact Build

on:
  push:
    branches: [main, alpha, beta]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  branch_artifact:
    runs-on: ubuntu-latest

    steps:
    - name: Determine target branch
      id: target
      env:
        REF_NAME: ${{ github.ref_name }}
      run: |
        BRANCH="$REF_NAME"

        SAFE_BRANCH="${BRANCH//\//-}"

        echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
        echo "safe_branch=$SAFE_BRANCH" >> "$GITHUB_OUTPUT"

    - name: Checkout target branch with submodules
      uses: actions/checkout@v4
      with:
        ref: ${{ steps.target.outputs.branch }}
        submodules: recursive
        fetch-depth: 0
        token: ${{ secrets.PERSONAL_TOKEN }}

    - name: Sync and update submodules
      run: |
        git submodule sync --recursive
        git submodule update --init --recursive

    - name: Switch submodules to target branch (optional)
      run: |
        git submodule foreach '
          BRANCH="${{ steps.target.outputs.branch }}"
          echo "Checking $name for $BRANCH branch"
          git fetch origin "$BRANCH" || true
          if git show-ref --verify --quiet "refs/remotes/origin/$BRANCH"; then
            git checkout "$BRANCH"
            git pull origin "$BRANCH"
          else
            echo "Branch $BRANCH not found in $name, staying on current branch"
          fi
        '

    - name: Create branch zip archive
      run: |
        ZIP_NAME="${{ steps.target.outputs.safe_branch }}.zip"
        zip -r "$ZIP_NAME" . -x '*.git*'

    - name: Upload branch zip artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.target.outputs.safe_branch }}-zip
        path: ${{ steps.target.outputs.safe_branch }}.zip
        if-no-files-found: error
        retention-days: 14

    - name: Publish zip to static artifacts branch
      env:
        REPOSITORY: ${{ github.repository }}
        GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
      run: |
        set -e
        ZIP_NAME="${{ steps.target.outputs.safe_branch }}.zip"
        PUBLISH_DIR="$(mktemp -d)"

        git init "$PUBLISH_DIR"
        cd "$PUBLISH_DIR"
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${REPOSITORY}.git"

        git fetch --depth 1 origin artifacts || true
        if git show-ref --verify --quiet refs/remotes/origin/artifacts; then
          git checkout -B artifacts refs/remotes/origin/artifacts
        else
          git checkout --orphan artifacts
          git rm -rf . || true
        fi

        cp "$GITHUB_WORKSPACE/$ZIP_NAME" "$ZIP_NAME"
        git add "$ZIP_NAME"

        if git diff --cached --quiet; then
          echo "No changes to publish for $ZIP_NAME"
        else
          git commit -m "Update $ZIP_NAME"
          git push origin artifacts
        fi

    - name: Show static download link
      run: |
        echo "Static download URL: https://raw.githubusercontent.com/${{ github.repository }}/artifacts/${{ steps.target.outputs.safe_branch }}.zip"
